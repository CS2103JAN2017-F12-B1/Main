# A0140036X
###### \java\savvytodo\logic\commands\LoadCommand.java
``` java
    /**
     * Will post a LoadStorageFileEvent to EventsCenter
     */
    @Override
    public CommandResult execute() throws CommandException {
        EventsCenter.getInstance().post(new LoadStorageFileEvent(filePath));
        return new CommandResult(getSuccessMessage(filePath));
    }

```
###### \java\savvytodo\logic\commands\LoadCommand.java
``` java
    /**
     * Returns success message if file path was loaded successfully
     * @param filePath file path of file
     */
    public static String getSuccessMessage(String filePath) {
        return String.format(MESSAGE_SUCCESS, filePath);
    }
}
```
###### \java\savvytodo\MainApp.java
``` java
    /**
     * Sets up application UI. Updates UI with new logic and storage if UI already exists.
     * If useSampleDataIfStorageFileNotFound is true sample data will be loaded if storage file is not found.
     * @author A0140036X
     * @param configFilePath File path of json file containing configurations
     * @param useSampleDataIfStorageFileNotFound
     */
    public void initApplicationFromConfig(String configFilePath, boolean useSampleDataIfStorageFileNotFound) {
        config = initConfig(configFilePath);

        storage = new StorageManager(config.getTaskManagerFilePath(), config.getUserPrefsFilePath());

        userPrefs = initPrefs(config);

        initLogging(config);

        model = initModelManager(storage, userPrefs, useSampleDataIfStorageFileNotFound ? null : new TaskManager());

        logic = new LogicManager(model, storage);

        if (ui == null) {
            ui = new UiManager(logic, config, userPrefs);
        } else {
            ui.setLogic(logic);
            ui.setConfig(config);
            ui.refresh();
        }
    }

    private String getApplicationParameter(String parameterName) {
        Map<String, String> applicationParameters = getParameters().getNamed();
        return applicationParameters.get(parameterName);
    }

```
###### \java\savvytodo\MainApp.java
``` java
    /**
     * Initializes model based on storage.
     * If storage file is not found, default task manager provided will be used.
     * If task manager is null, sample task manager will be created.
     * @param storage Storage that is to be used by model
     * @param userPrefs User preferences for application
     * @param defaultTaskManager see method description
     * @return initialized Model
     */
    private Model initModelManager(Storage storage, UserPrefs userPrefs, TaskManager defaultTaskManager) {
        Optional<ReadOnlyTaskManager> taskManagerOptional;
        ReadOnlyTaskManager initialData;
        try {
            taskManagerOptional = storage.readTaskManager();
            if (!taskManagerOptional.isPresent()) {
                logger.info("Data file not found. Will be starting with "
                        + ((defaultTaskManager == null ? "a sample " : "provided ") + "TaskManager"));
            }
            logger.info("Data file found " + storage.getTaskManagerFilePath());
            initialData = taskManagerOptional.orElseGet(
                    defaultTaskManager == null ? SampleDataUtil::getSampleTaskManager : () -> new TaskManager());
        } catch (DataConversionException e) {
            logger.warning("Data file not in the correct format. Will be starting with an empty TaskManager");
            initialData = new TaskManager();
        } catch (IOException e) {
            logger.warning("Problem while reading from the file. Will be starting with an empty TaskManager");
            initialData = new TaskManager();
        }

        return new ModelManager(initialData, userPrefs);
    }

    private void initLogging(Config config) {
        LogsCenter.init(config);
    }

    /**
     * Loads config file from configFilePath. If not specified, MainApp.configFile will be used.
     * @param configFilePath
     * @return initialized Config
     */
    protected Config initConfig(String configFilePath) {
        Config initializedConfig;

        if (configFilePath != null) {
            logger.info("Custom Config file specified " + configFilePath);
            configFile = configFilePath;
        }

        logger.info("Using config file : " + configFile);

        try {
            Optional<Config> configOptional = ConfigUtil.readConfig(configFile);
            initializedConfig = configOptional.orElse(new Config());
        } catch (DataConversionException e) {
            logger.warning("Config file at " + configFile + " is not in the correct format. "
                    + "Using default config properties");
            initializedConfig = new Config();
        }

        //Update config file in case it was missing to begin with or there are new/unused fields
        try {
            ConfigUtil.saveConfig(initializedConfig, configFile);
        } catch (IOException e) {
            logger.warning("Failed to save config file : " + StringUtil.getDetails(e));
        }
        return initializedConfig;
    }

    /**
     * Initialized user preferences from file stored in a Config object.
     * Guarantees a UserPrefs
     * @param config
     * @return user preferences
     */
    protected UserPrefs initPrefs(Config config) {
        assert config != null;

        String prefsFilePath = config.getUserPrefsFilePath();
        logger.info("Using prefs file : " + prefsFilePath);

        UserPrefs initializedPrefs = loadUserPrefsFromFile(prefsFilePath);

        //Update prefs file in case it was missing to begin with or there are new/unused fields
        saveUserPrefs(initializedPrefs);

        return initializedPrefs;
    }

```
###### \java\savvytodo\MainApp.java
``` java
    /**
     * Attempt to load user preferences from file
     * Guarantees a UserPrefs even if file not found
     * @return user preferences
     */
    private UserPrefs loadUserPrefsFromFile(String prefsFilePath) {
        UserPrefs initializedPrefs;
        try {
            Optional<UserPrefs> prefsOptional = storage.readUserPrefs();
            initializedPrefs = prefsOptional.orElse(new UserPrefs());
        } catch (DataConversionException e) {
            logger.warning("UserPrefs file at " + prefsFilePath + " is not in the correct format. "
                    + "Using default user prefs");
            initializedPrefs = new UserPrefs();
        } catch (IOException e) {
            logger.warning("Problem while reading from the file. Will be starting with an empty TaskManager");
            initializedPrefs = new UserPrefs();
        }
        return initializedPrefs;
    }

```
###### \java\savvytodo\MainApp.java
``` java
    /**
     * Attempt to save user preferences to storage
     * @param prefs
     * @return true if successful
     */
    protected boolean saveUserPrefs(UserPrefs prefs) {
        try {
            storage.saveUserPrefs(prefs);
            return true;
        } catch (IOException e) {
            logger.warning("Failed to save preference file : " + StringUtil.getDetails(e));
            return false;
        }
    }

    private void initEventsCenter() {
        EventsCenter.getInstance().registerHandler(this);
    }

    @Override
    public void start(Stage primaryStage) {
        logger.info("Starting TaskManager " + MainApp.VERSION);
        ui.start(primaryStage);
    }

    @Override
    public void stop() {
        logger.info("============================ [ Stopping Task Manager ] =============================");
        ui.stop();
        try {
            storage.saveUserPrefs(userPrefs);
        } catch (IOException e) {
            logger.severe("Failed to save preferences " + StringUtil.getDetails(e));
        }
        Platform.exit();
        System.exit(0);
    }

    @Subscribe
    public void handleExitAppRequestEvent(ExitAppRequestEvent event) {
        logger.info(LogsCenter.getEventHandlingLogMessage(event));
        this.stop();
    }

```
###### \java\savvytodo\MainApp.java
``` java
    /**
     * Loads a new task manager file.
     * 1. Update and save config file with new storage file path
     * 2. Update UI with new logic
     */
    @Subscribe
    public void handleLoadStorageFileEvent(LoadStorageFileEvent event) {
        logger.info(LogsCenter.getEventHandlingLogMessage(event));
        String taskManagerFilePath = event.getFilePath();
        config.setTaskManagerFilePath(taskManagerFilePath);

        try {
            ConfigUtil.saveConfig(config, configFile);
        } catch (IOException e) {
            logger.severe("Failed to save config " + StringUtil.getDetails(e));
            this.stop();
        }

        logger.info("Setting UI with new logic");
        initApplicationFromConfig(configFile, false);
    }

    public static void main(String[] args) {
        launch(args);
    }
}
```
###### \java\savvytodo\ui\CommandBox.java
``` java
    /**
     * Sets logic for command box
     * @param logic
     */
    public void setLogic(Logic logic) {
        this.logic = logic;
    }

}
```
###### \java\savvytodo\ui\MainWindow.java
``` java
    /**
     * Fills the contents of the window.
     * Will create new objects if UI has not been initialized.
     * Logic will be updated if UI is already initialized.
     */
    void fillInnerParts() {
        browserPanel = new BrowserPanel(browserPlaceholder);

        if (taskListPanel == null) {
            taskListPanel = new TaskListPanel(getTaskListPlaceholder(), logic.getFilteredTaskList());
        } else {
            taskListPanel.setConnections(logic.getFilteredTaskList());
        }

        if (resultDisplay == null) {
            resultDisplay = new ResultDisplay(getResultDisplayPlaceholder());
        }

        if (statusBar == null) {
            statusBar = new StatusBarFooter(getStatusbarPlaceholder(), config.getTaskManagerFilePath());
        } else {
            statusBar.setSaveLocation(config.getTaskManagerFilePath());
        }

        if (commandBox == null) {
            commandBox = new CommandBox(getCommandBoxPlaceholder(), logic);
        } else {
            commandBox.setLogic(logic);
        }
    }

    private AnchorPane getCommandBoxPlaceholder() {
        return commandBoxPlaceholder;
    }

    private AnchorPane getStatusbarPlaceholder() {
        return statusbarPlaceholder;
    }

    private AnchorPane getResultDisplayPlaceholder() {
        return resultDisplayPlaceholder;
    }

    private AnchorPane getTaskListPlaceholder() {
        return taskListPanelPlaceholder;
    }

    void hide() {
        primaryStage.hide();
    }

    private void setTitle(String appTitle) {
        primaryStage.setTitle(appTitle);
    }

    /**
     * Sets the given image as the icon of the main window.
     * @param iconSource e.g. {@code "/images/help_icon.png"}
     */
    private void setIcon(String iconSource) {
        FxViewUtil.setStageIcon(primaryStage, iconSource);
    }

    /**
     * Sets the default size based on user preferences.
     */
    private void setWindowDefaultSize(UserPrefs prefs) {
        primaryStage.setHeight(prefs.getGuiSettings().getWindowHeight());
        primaryStage.setWidth(prefs.getGuiSettings().getWindowWidth());
        if (prefs.getGuiSettings().getWindowCoordinates() != null) {
            primaryStage.setX(prefs.getGuiSettings().getWindowCoordinates().getX());
            primaryStage.setY(prefs.getGuiSettings().getWindowCoordinates().getY());
        }
    }

    private void setWindowMinSize() {
        primaryStage.setMinHeight(MIN_HEIGHT);
        primaryStage.setMinWidth(MIN_WIDTH);
    }

    /**
     * Returns the current size and the position of the main Window.
     */
    GuiSettings getCurrentGuiSetting() {
        return new GuiSettings(primaryStage.getWidth(), primaryStage.getHeight(), (int) primaryStage.getX(),
                (int) primaryStage.getY());
    }

    @FXML
    public void handleHelp() {
        HelpWindow helpWindow = new HelpWindow();
        helpWindow.show();
    }

    void show() {
        primaryStage.show();
    }

    /**
     * Closes the application.
     */
    @FXML
    private void handleExit() {
        raise(new ExitAppRequestEvent());
    }

    public TaskListPanel getTaskListPanel() {
        return this.taskListPanel;
    }

    void loadTaskPage(ReadOnlyTask task) {
        browserPanel.loadTaskPage(task);
    }

    void releaseResources() {
        browserPanel.freeResources();
    }

    /**
     * @return logic
     */
    public Logic getLogic() {
        return logic;
    }

```
###### \java\savvytodo\ui\MainWindow.java
``` java
    /**
     * Sets the logic for the window
     * @param logic
     */
    public void setLogic(Logic logic) {
        this.logic = logic;
    }

```
###### \java\savvytodo\ui\MainWindow.java
``` java
    /**
     * Sets config for the window
     * @param config
     */
    public void setConfig(Config config) {
        this.config = config;
    }

```
###### \java\savvytodo\ui\Ui.java
``` java
    /** Set UI with new logic Note: Does not refresh the UI */
    void setLogic(Logic logic);

```
###### \java\savvytodo\ui\Ui.java
``` java
    /** Set UI with new config. Note: Does not refresh the UI */
    void setConfig(Config config);

```
###### \java\savvytodo\ui\Ui.java
``` java
    /** Links UI to underlying logic and config and updates UI */
    void refresh();
}
```
###### \java\savvytodo\ui\UiManager.java
``` java
    /**
     * Sets logic of instance
     */
    public void setLogic(Logic logic) {
        this.logic = logic;
    }

```
###### \java\savvytodo\ui\UiManager.java
``` java
    /**
     * Sets config of instance
     * @return
     */
    public void setConfig(Config config) {
        this.config = config;
    }

    public MainWindow getMainWindow() {
        return mainWindow;
    }

    public void setMainWindow(MainWindow mainWindow) {
        this.mainWindow = mainWindow;
    }

    @Override
    public void stop() {
        prefs.updateLastUsedGuiSetting(mainWindow.getCurrentGuiSetting());
        mainWindow.hide();
        mainWindow.releaseResources();
    }

    private void showFileOperationAlertAndWait(String description, String details, Throwable cause) {
        final String content = details + ":\n" + cause.toString();
        showAlertDialogAndWait(AlertType.ERROR, "File Op Error", description, content);
    }

    private Image getImage(String imagePath) {
        return new Image(MainApp.class.getResourceAsStream(imagePath));
    }

    void showAlertDialogAndWait(Alert.AlertType type, String title, String headerText, String contentText) {
        showAlertDialogAndWait(mainWindow.getPrimaryStage(), type, title, headerText, contentText);
    }

    private static void showAlertDialogAndWait(Stage owner, AlertType type, String title, String headerText,
            String contentText) {
        final Alert alert = new Alert(type);
        alert.getDialogPane().getStylesheets().add("view/DarkTheme.css");
        alert.initOwner(owner);
        alert.setTitle(title);
        alert.setHeaderText(headerText);
        alert.setContentText(contentText);
        alert.getDialogPane().setId(ALERT_DIALOG_PANE_FIELD_ID);
        alert.showAndWait();
    }

    private void showFatalErrorDialogAndShutdown(String title, Throwable e) {
        logger.severe(title + " " + e.getMessage() + StringUtil.getDetails(e));
        showAlertDialogAndWait(Alert.AlertType.ERROR, title, e.getMessage(), e.toString());
        Platform.exit();
        System.exit(1);
    }

    //==================== Event Handling Code ===============================================================

    @Subscribe
    private void handleDataSavingExceptionEvent(DataSavingExceptionEvent event) {
        logger.info(LogsCenter.getEventHandlingLogMessage(event));
        showFileOperationAlertAndWait("Could not save data", "Could not save data to file", event.exception);
    }

    @Subscribe
    private void handleShowHelpEvent(ShowHelpRequestEvent event) {
        logger.info(LogsCenter.getEventHandlingLogMessage(event));
        mainWindow.handleHelp();
    }

    @Subscribe
    private void handleJumpToListRequestEvent(JumpToListRequestEvent event) {
        logger.info(LogsCenter.getEventHandlingLogMessage(event));
        mainWindow.getTaskListPanel().scrollTo(event.targetIndex);
    }

    @Subscribe
    private void handleTaskPanelSelectionChangedEvent(TaskPanelSelectionChangedEvent event) {
        logger.info(LogsCenter.getEventHandlingLogMessage(event));
        mainWindow.loadTaskPage(event.getNewSelection());
    }

    @Override
    public void refresh() {
        mainWindow.setLogic(logic);
        mainWindow.setConfig(config);
        mainWindow.fillInnerParts();
    }

}
```
